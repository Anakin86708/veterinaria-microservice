version: '3'
services:
  mysql:
    image: mysql
    ports:
      - '3306:3306'
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=veterinaria_test
      - MYSQL_USER=appuser
      - MYSQL_PASSWORD=1234
  mariadb:
    image: mariadb
    expose:
      - "3306"
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=${AUTH_DATABASE_NAME}
      - MYSQL_USER=keycloak
      - MYSQL_PASSWORD=password
    volumes:
      - "auth_bd_test:/var/lib/mysql:rw"
  api-gateway:
    image: 'anakin86708/veterinaria-api-gateway:0.0.1-SNAPSHOT'
    ports:
      - '8765:8765'
    restart: 'no'
    depends_on:
      - naming-server
      - zipkin
    environment:
      - 'EUREKA.CLIENT.SERVICEURL.DEFAULTZONE=http://naming-server:8761/eureka'
  zipkin:
    image: openzipkin/zipkin
    ports:
      - '9411:9411'
    restart: unless-stopped
  keycloak:
    image: jboss/keycloak:latest
    ports:
      - "8810:8080"
    environment:
      - KEYCLOAK_USER=admin
      - KEYCLOAK_PASSWORD=admin
      - DB_VENDOR=mariadb
      - DB_ADDR=mariadb
      - DB_DATABASE=${AUTH_DATABASE_NAME}
    depends_on:
      - mariadb
    volumes:
      - "keycloak_data_test:/opt/jboss/keycloak/standalone/data/"
  naming-server:
    image: 'anakin86708/veterinaria-naming-server:0.0.1-SNAPSHOT'
    ports:
      - '8761:8761'
    restart: 'no'
  especie-service:
    image: 'anakin86708/especie-service:0.0.1-SNAPSHOT'
    ports:
      - '8400:8400'
    restart: 'no'
    depends_on:
      - api-gateway
      - naming-server
      - mysql
    environment:
      - 'EUREKA.CLIENT.SERVICEURL.DEFAULTZONE=http://naming-server:8761/eureka'
      - "SPRING_PROFILES_ACTIVE=test"
      - "DATABASE_URL=mysql"

  cliente-service:
    image: 'anakin86708/cliente-service:0.0.1-SNAPSHOT'
    ports:
      - '8200:8200'
    restart: 'no'
    depends_on:
      - api-gateway
      - naming-server
      - mysql
    environment:
      - 'EUREKA.CLIENT.SERVICEURL.DEFAULTZONE=http://naming-server:8761/eureka'
      - "SPRING_PROFILES_ACTIVE=test"
      - "DATABASE_URL=mysql"

volumes:
  auth_bd_test:
  keycloak_data_test:
